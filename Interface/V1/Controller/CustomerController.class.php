<?php/** * 乘客接口API */namespace V1\Controller;use Common\Controller\ApiController;header('Content-Type: application/x-javascript; charset=UTF-8');class CustomerController extends ApiController{    public function index(){            $this->show(300,'无效接口');    }    // 约车添加或设置    public function appointCar()    {        if (IS_POST) {            if (!I('request.id')){                $this->show(301, '未获用户id参数或该id不存在');            }             // $users_id=84;             $users_id=I('request.id');  //用户id 乘客id             $shuttle = M('shuttle');             $info = $shuttle->where("users_id='$users_id'")->field('home_addr,company_addr,on_work_time,off_work_time')->find();             $start_time1=I('request.start_time');             $start_time2=$info['on_work_time'];             $start_time = (!empty($start_time1)) ? $start_time1 : $start_time2;             $start_pos1=I('request.start_pos','');             $start_pos2=$info['home_addr'];             $start_pos = (!empty($start_pos1)) ? $start_pos1 : $start_pos2;             $end_pos1=I('request.end_pos','');             $end_pos2=$info['company_addr'];             $end_pos = (!empty($end_pos1)) ? $end_pos1 : $end_pos2;             $data['users_id']=$users_id;             $data['companion'] =$companion= I('request.companion');             $data['start_time']=$start_time;             $str_start_time=strtotime($start_time);             $data['str_start_time']=$str_start_time;             $data['start_pos']=$start_pos;             $data['end_pos']=$end_pos;             $data['create_time']=time();             $data['type']=2;            //实例化cab表            $cab=M('cab');            $obj = $cab->create($data);            if(!$obj){                $this->show(300,$cab->getError());            }else{                $result = $cab->data($data)->add();                if ($result === false){                   $this->show(302, '添加失败，请稍后再试');                }else{                    // $pageNum = I('get.pageNum',1);                    // $pageCount = I('get.pageCount',2);                    $timeDiff = 30 * 60;  //30分                    $smallTime = ($str_start_time-$timeDiff);                    $bigTime = ($str_start_time+$timeDiff);                    $map['c.start_pos'] = array(array('like',"%$start_pos%"),array('like',"%$start_pos"),array('like',"$start_pos%"),$start_pos,'or');                    $map['c.type'] = "1";                    $map['c.str_start_time'] = array(array('gt',$smallTime),array('lt',$bigTime));                    $where['p.passby_pos'] =$start_pos;                    $where['c.type'] =1;                    // 途径地                    $cabList1 = $cab->alias('c')                                ->join('LEFT JOIN passby p ON c.users_id = p.users_id')                                ->join('LEFT JOIN users u ON c.users_id = u.id')                                ->join('LEFT JOIN certification c2 ON c.users_id = c2.users_id')                                ->field('u.tel,u.img,c2.car_color,c2.car_brand,c2.real_name,c.cab_id,c.users_id,c.start_time,c.passby_pos,c.companion,c.start_pos,c.start_pos_img,c.end_pos,c.price,c.start_pos_img,c.type,c.status,c.create_time')                                ->where($where)                                // ->page($pageNum,$pageCount)                                ->select();                    $cabList2 = $cab->alias('c')                                ->join('LEFT JOIN users u ON c.users_id = u.id')                                ->join('LEFT JOIN certification c2 ON c.users_id = c2.users_id')                                ->field('u.tel,u.img,c2.car_color,c2.car_brand,c2.real_name,c.cab_id,c.users_id,c.start_time,c.passby_pos,c.companion,c.start_pos,c.start_pos_img,c.end_pos,c.price,c.start_pos_img,c.type,c.status,c.create_time')                                ->where($map)                                ->select();                    $list = array_merge($cabList1,$cabList2);                    if (!$list) {                        $this->show(303,'无匹配数据',$list);                    }else{                        $this->show(200,'success',$list);                    }                }            }        }else{            $this->show(300, '请使用post提交');        }    }    // 乘客乘车与车主状态码    public function takeCarStatus()    {        if (IS_POST) {            if (!I('request.pid')){                $this->show(300, '未获乘客id参数或该id不存在');            }            if (!I('request.status')){                $this->show(300, '未获状态参数');            }            if (!I('request.cab_id')){                $this->show(300, '未获id参数');            }            $pid=I('request.pid');  //乘客id 用户的id            $status = I('request.status');            $cab_id=I('request.cab_id');  //cab表的id            $cab = M('cab');            $p_data = $cab->where("users_id='$pid'")->find();            $users_id = $cab->where("users_id='$pid'")->getField('users_id');            $p_cellphone = M('users')->where("id='$users_id'")->getField('tel');            $data['passager_id'] = $p_data['users_id'];            $data['companion'] = $p_data['companion'];            $data['create_time'] = time();            $data['order_state'] = 10;            $data['passager_cellphone'] = $p_cellphone;            // 车主信息            $c_data = $cab->where("cab_id='$cab_id'")->find();            $users_id = $cab->where("cab_id='$cab_id'")->getField('users_id');            $c_cellphone = M('users')->where("id='$users_id'")->getField('tel');            $data['cab_id'] = $c_data['cab_id'];            $data['carowner_id'] = $c_data['users_id'];            $data['carowner_cellphone'] = $c_cellphone;            $data['price'] = $c_data['price'];            $data['start_time'] = $c_data['start_time'];            $data['start_pos'] = $c_data['start_pos'];            $data['end_pos'] = $c_data['end_pos'];            $data['start_pos_img'] = $c_data['start_pos_img,'];            // 从认证信息中获取车颜色和品牌            $certification = M('certification');            $certifications = $certification->where("users_id='$users_id'")->find();            $car_color = $certifications['car_color'];            $car_brand = $certifications['car_brand'];            $data['car_color'] = $car_color;            $data['car_brand'] = $car_brand;            $data['status'] = 2;            //实例化cab表            $p_companion = $cab->where("cab_id='$pid'")->getField('companion');  //2            $c_companion = $cab->where("cab_id='$cab_id'")->getField('companion');  //5            $num = $c_companion-$p_companion;            $num1 = $c_companion+$p_companion;             //实例化order表            $order=M('order_cab');            $obj = $order->create($data);            if(!$obj){                $this->show(300,$order->getError());            }            $order_id = $order->where("cab_id='$cab_id'")->getField('order_cab_id');            $passager_ids = $order->where("cab_id='$cab_id'")->getField('passager_id',true);            $cabs_id = $order->where("cab_id='$cab_id'")->getField('cab_id');            $state = $order->where("cab_id='$cab_id'")->getField('status');            if (!in_array($pid,$passager_ids)) {                    $result = $order->data($data)->add();                    if ($result === false){                       $this->show(300, '添加失败，请稍后再试');                    }else{                        $this->show(200,'success:等待车主确认',2);                    }                }else{                    switch ($status) {                        case '1':                            $order->where("cab_id = '$cab_id'")->setField('status',1);                            $where['cab_id'] = $cab_id;                            $where['passager_id'] = $pid;                            $data = $order->alias('o')                                           ->join('LEFT JOIN users u ON o.carowner_id = u.id')                                           ->join('LEFT JOIN certification c2 ON o.carowner_id = c2.users_id')                                           ->field('o.order_cab_id,o.cab_id,o.passager_id,o.carowner_id,u.img,c2.real_name,o.passager_cellphone,o.carowner_cellphone,o.start_time,o.start_pos,o.end_pos,o.companion,o.car_color,o.car_brand,o.price,o.status,o.order_state')                                           ->where($where)                                           ->select();                            $this->show(200,'success',$data);                            break;                        case '2':                            if (in_array($pid, $passager_ids) && ($state==2)) {                                $this->show(200,'success:已经约过该车');                                break;                            }else{                                $order->where("cab_id = '$cab_id'")->setField('status',2);                                $this->show(200,'success:等待车主确认',2);                                break;                            }                        case '3':                            $where['cab_id'] = $cab_id;                            $where['passager_id'] = $pid;                            $orderInfo = $order->where($where)->delete();  //乘客被拒绝                            $this->show(200,'success:被拒绝',$orderInfo);                            break;                        case '4':                            $this->show(200,'success:预约成功');                            break;                        case '5':                            $this->show(200,'success:失约');                            break;                        case '6':                            $this->show(200,'success:乘客已上车');                            break;                        case '7':                            $where['cab_id'] = $cab_id;                            $where['passager_id'] = $pid;                            $data = $order->alias('o')                                           ->join('LEFT JOIN users u ON o.passager_id = u.id')                                           ->join('LEFT JOIN certification c2 ON o.carowner_id = c2.users_id')                                           ->field('o.order_cab_id,o.cab_id,o.passager_id,o.carowner_id,u.img,c2.real_name,o.passager_cellphone,o.carowner_cellphone,o.start_time,o.start_pos,o.end_pos,o.companion,o.car_color,o.car_brand,o.price,o.status,o.order_state')                                           ->where($where)                                           ->select();                            if (!$data) {                                $this->show(300,'fail');                            }else{                                $this->show(200,'success:到达目的地',$data);                            }                            break;                        case '8':                            $where['cab_id'] = $cab_id;                            $where['passager_id'] = $pid;                            $orderInfo = $order->where($where)->delete();  //乘客被拒绝                            $this->show(200,'success:删除',8);                            break;                        case '9':                            $where['cab_id'] = $cab_id;                            $where['passager_id'] = $pid;                            $order->where($where)->setField('status',9);                            $this->show(200,'success:已支付',9);                            break;                        default:                            $this->show(300,'fail','服务器繁忙，请稍后再试');                            break;                    }                }         }else{            $this->show(300, '请使用post提交');        }    }    // 获取乘客预约后列表(车主列表)(未处理)    public function getCarownerListByPid()    {        if (!I('request.pid')){            $this->show(301, '未获乘客id参数');        }        $passager_id=I('request.pid');        //实例化order表        $order=M('order_cab');        $where['o.passager_id'] = $passager_id;        $where['o.order_state'] = '10';        $data = $order->alias('o')                           ->join('LEFT JOIN users u ON o.carowner_id = u.id')                           ->join('LEFT JOIN cab c ON o.cab_id = c.cab_id')                           ->join('LEFT JOIN certification c2 ON o.carowner_id = c2.users_id')                           ->field('o.order_cab_id,o.cab_id,o.passager_id,o.carowner_id,u.img,c.start_pos_img,c2.real_name,o.passager_cellphone,o.carowner_cellphone,o.start_time,o.start_pos,o.end_pos,o.companion,o.car_color,o.car_brand,o.price,o.status,o.order_state')                           ->where($where)                           ->select();        if ($data === false){               $this->show(302, '没有数据');            }else{                $this->show(200, 'success',$data);            }    }    // 乘客完成订单接口    public function finishOrder()    {        if (IS_POST) {            if (!I('request.order_cab_id')){                $this->show(301, '未获order_cab_id参数');            }            if (!I('request.payment_type')){                $this->show(302, '未获取支付类型 支付(付款)方式 1微信 2支付宝');            }            $order_cab_id=I('request.order_cab_id');            $data['payment_type']=I('request.payment_type');            // $data['order_state']=I('request.order_state');            $data['order_state']=20;            $data['finished_time']=time();            //实例化order表            $order=M('order_cab');            if ($data === false){                   $this->show(304, '操作失败');                }else{                    $result = $order->where("order_cab_id = '$order_cab_id'")->data($data)->save();                    $this->show(200, 'success',$result);                }        }else{            $this->show(300, '请使用post提交');        }    }    // 获取订单行程    public function getRouteBypid()    {        if (!I('request.pid')){            $this->show(300, '未获乘客id参数或该id不存在');        }         // $id=84;        $pid=I('request.pid');        //实例化order表        $order=M('order_cab');        $where['passager_id'] = $pid;        $where['order_state'] = '20';        $data = $order->where($where)->select();        if ($data === false){               $this->show(301, '没有数据');            }else{                $this->show(200, 'success',$data);            }    }}